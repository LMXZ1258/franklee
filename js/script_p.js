
let allMusic =[
  {
    src:"https://cloud.lmxz.repl.co/d/%E8%87%AA%E7%94%A8/%E6%AD%8C%E6%9B%B2/Aimer%20-%20%E3%82%AB%E3%82%BF%E3%82%AA%E3%83%A2%E3%82%A4%20(%E5%8D%95%E7%9B%B8%E6%80%9D).flac?sign=9mE7pVZf2HrGRHcc7GFg61ffG9RIXuaZZNqCAr9I-XU=:0",
    name : "カタオモイ",
    artist:"Aimer",
  },
  {
    src:"https://cloud.lmxz.repl.co/d/%E8%87%AA%E7%94%A8/%E6%AD%8C%E6%9B%B2/%E4%B8%89%E6%B5%A6%E9%80%8F%E5%AD%90%E3%80%81RADWIMPS%20-%20%E3%82%B0%E3%83%A9%E3%83%B3%E3%83%89%E3%82%A8%E3%82%B9%E3%82%B1%E3%83%BC%E3%83%97%20(%E9%80%83%E7%A6%BB%E5%9C%B0%E9%9D%A2)%20(Movie%20edit).flac?sign=gU0QMYlXPcBZ4LNy-jr8g3NPscwxleqsJsCL-ZyyMmE=:0",
    name : "逃离地面",
    artist:"三浦透子、RADWIMPS",
  },
  {
    src:"https://cloud.lmxz.repl.co/d/%E8%87%AA%E7%94%A8/%E6%AD%8C%E6%9B%B2/Aimer%20-%20%E3%82%B3%E3%82%A4%E3%83%AF%E3%82%BA%E3%83%A9%E3%82%A4%20(%E7%9B%B8%E6%80%9D%E7%97%85).mp3?sign=VBN9j2oGv7j6xhI-DLtRcBqoTiP8834J9Zg-kpsOlk8=:0",
    name : "コイワズライ",
    artist:"Aimer",
  },
  {
    src:"http://music.163.com/song/media/outer/url?id=1466544976",
    name : "Ross And Rachel",
    artist:"Jake Miller",
  },
  
  {
      src:"http://music.163.com/song/media/outer/url?id=1817629883",
      name : "Runaway",
      artist:"AURORA",
  },
    {
    src:"https://cloud.lmxz.repl.co/d/%E8%87%AA%E7%94%A8/%E6%AD%8C%E6%9B%B2/Lenka%20-%20Blue%20Skies.flac?sign=U8T6Ahpf8avvGFQklDyTh0eKyf0suzRyau2SOs9XjK8=:0",
    name : "blue skies",
    artist:"Lenka", 
  },
  {
    src:"https://cloud.lmxz.repl.co/d/%E8%87%AA%E7%94%A8/%E6%AD%8C%E6%9B%B2/Aimer%20-%20%E7%B3%B8.flac?sign=g1BxE_0XMLXXgSUee7xga3FiZZPdc3K2flchF-v_IU8=:0",
    name : "糸",
    artist:"Aimer",
  },
  {
    src:"https://cloud.lmxz.repl.co/d/%E8%87%AA%E7%94%A8/%E6%AD%8C%E6%9B%B2/RADWIMPS%E3%80%81%E5%8D%81%E6%98%8E%20-%20%E3%81%99%E3%81%9A%E3%82%81%20feat.%E5%8D%81%E6%98%8E.flac?sign=dSV7nLsY8IY7QbqGW0tPn8mG__iAtcHH3KQpkgR4NRI=:0",
    name : "十明",
    artist:"十明、RADWIMPS",
  },
  {
    src:"https://cloud.lmxz.repl.co/d/%E8%87%AA%E7%94%A8/%E6%AD%8C%E6%9B%B2/%E6%B0%B4%E7%80%AC%E3%81%84%E3%81%AE%E3%82%8A%20-%20Wishing.flac?sign=MCKEhq19GCE-RXBKUac66PGxNnTBYgpMLww2elSZzbI=:0",
    name : "Wishing",
    artist:"水瀬いのり",
  },
  {  
    src : "http://music.163.com/song/media/outer/url?id=28987615",
    name : "Radio Mix 6-2",
    artist:"Marie Miller",
  },
  {
    src : "http://music.163.com/song/media/outer/url?id=857896",
    name :"ALittle Story",
    artist:"Valentin",
  },
  {
  src : "http://music.163.com/song/media/outer/url?id=1917549208",
  name : "Love Story",
  artist:"Taylor Swift",
  },
  {  
    src : "https://cloud.lmxz.repl.co/d/%E8%87%AA%E7%94%A8/%E6%AD%8C%E6%9B%B2/Ed%20Sheeran%20-%20Celestial.flac?sign=Mdn7JsQ484RA8XBvNGLbzRS5fQoy8XENcMcFcqGojVg=:0",
    name : "Celestial",
    artist:"Ed Sheeran",
  },
  {
    src:"https://cloud.lmxz.repl.co/d/%E8%87%AA%E7%94%A8/%E6%AD%8C%E6%9B%B2/%E4%B8%89%E6%B5%A6%E9%80%8F%E5%AD%90%20-%20%E3%81%8A%E3%81%A1%E3%81%A4%E3%81%91.flac?sign=6bw2MeaeLWpDWm8gSS7kEn6c2rjxEb140HXtIFWJdTc=:0",
    name : "おちつけ",
    artist:"三浦透子",
  },
  {  
    src : "https://cloud.lmxz.repl.co/d/%E8%87%AA%E7%94%A8/%E6%AD%8C%E6%9B%B2/G.E.M.%20%E9%82%93%E7%B4%AB%E6%A3%8B%20-%20%E6%A1%83%E8%8A%B1%E8%AF%BA.flac?sign=bu3KZqNSv65kFddBDxsBtyL8rLQffywr7gpQbxx1N_Y=:0",
    name : "桃花诺",
    artist:"邓紫棋",
  },
  {
    src:"https://cloud.lmxz.repl.co/d/%E8%87%AA%E7%94%A8/%E6%AD%8C%E6%9B%B2/Taylor%20Swift%20-%20All%20Of%20The%20Girls%20You%20Loved%20Before.mp3?sign=A1lxjvgjpX5jOSVhgl1fgnTSIgoUBsnmH5t7Yax-dvE=:0",
    name : "AllOfTheGirlYouLovedBefore",
    artist:"Taylor Swift",
  },
  {  
    src : "http://music.163.com/song/media/outer/url?id=25901050",
    name : "Liebesleid",
    artist:"何红英,姚珏",
  },
  {
    src:"https://freetyst.nf.migu.cn/public%2Fproduct9th%2Fproduct41%2F2020%2F07%2F3116%2F2017%E5%B9%B411%E6%9C%8827%E6%97%A514%E7%82%B936%E5%88%86%E7%B4%A7%E6%80%A5%E5%86%85%E5%AE%B9%E5%87%86%E5%85%A5SONY316%E9%A6%96%2F%E5%85%A8%E6%9B%B2%E8%AF%95%E5%90%AC%2FMp3_64_22_16%2F6005970SLFU163950.mp3?Key=b319ac8e3d12db8d&Tim=1672183214336&channelid=01&msisdn=92be56d972de4d8b977943a7090f1779",
    name : "So Far Away",
    artist:"Martin Garrix、David Guetta",
  },
  {
    src:"https://cloud.lmxz.repl.co/d/%E8%87%AA%E7%94%A8/%E6%AD%8C%E6%9B%B2/Ennio%20Morricone%20-%20Playing%20Love%20(Piano%20Version).flac?sign=ekSNHGgHD4bSkUq6D8p6-erFng30K6FyNoBLPUywjBQ=:0",
    name : "Playing Love",
    artist:"Ennio Morricone",
  },
  {
    src:"https://cloud.lmxz.repl.co/d/%E8%87%AA%E7%94%A8/%E6%AD%8C%E6%9B%B2/%E9%AB%98%E6%A1%A5%E6%9D%8E%E4%BE%9D%20-%20Stay%20Alive.flac?sign=LWIU2EW6lyMe76sknDSmfjV1oOxekJSOOzuEB3sibrQ=:0",
    name : "Stay Alive",
    artist:"高桥李依",
  },
  {  
    src : "http://music.163.com/song/media/outer/url?id=28987615",
    name : "Radio Mix 6-2",
    artist:"Marie Miller",
  },
  {
    src:"https://cloud.lmxz.repl.co/d/%E8%87%AA%E7%94%A8/%E6%AD%8C%E6%9B%B2/Marble%20Sounds%20-%20Leave%20A%20Light%20On.mp3?sign=xP-5HaRcNGgvfHseazdEs9tNokYhrcyuUTrLuUZkCFU=:0",
    name : "Leave A Light On",
    artist:"Marble Sounds",
  },
  {  
    src : "https://cloud.lmxz.repl.co/d/%E8%87%AA%E7%94%A8/%E6%AD%8C%E6%9B%B2/%E5%9D%82%E6%9C%AC%E9%BE%99%E4%B8%80%20-%20Aqua.flac?sign=wHgmqMctOeKZh4NrC0b-kjuDzLPe1wNpcXWdFH4i84g=:0",
    name : "月光",
    artist:"胡彦斌",
  },
  {
    src:"https://cloud.lmxz.repl.co/d/%E8%87%AA%E7%94%A8/%E6%AD%8C%E6%9B%B2/Taylor%20Swift%20-%20Style.flac?sign=90AuWbv0ZEQ435CuuDrccdfwtHZZFsDYfmw7sIkdrXc=:0",
    name : "Style",
    artist:"Taylor Swift",
  },
  {  
    src : "https://freetyst.nf.migu.cn/public%2Fproduct5th%2Fproduct35%2F2019%2F09%2F2521%2F2018%E5%B9%B406%E6%9C%8830%E6%97%A521%E7%82%B900%E5%88%86%E5%86%85%E5%AE%B9%E5%87%86%E5%85%A5%E7%88%B1%E7%A8%BB%E8%8D%891%E9%A6%96%2F%E5%85%A8%E6%9B%B2%E8%AF%95%E5%90%AC%2FMp3_64_22_16%2F63273402355.mp3?Key=d6c1152c2db27951&Tim=1669971541230&channelid=01&msisdn=06a8ff43d52e4251b8f91c845c03d4b3",
    name : "叹云兮",
    artist:"鞠婧祎",
  },
  {
    src:"https://cloud.lmxz.repl.co/d/%E8%87%AA%E7%94%A8/%E6%AD%8C%E6%9B%B2/%E4%B8%AD%E5%B2%9B%E7%BE%8E%E9%9B%AA%20-%20%E9%8A%80%E3%81%AE%E9%BE%8D%E3%81%AE%E8%83%8C%E3%81%AB%E4%B9%97%E3%81%A3%E3%81%A6%20(%E9%AA%91%E5%9C%A8%E9%93%B6%E9%BE%99%E7%9A%84%E8%83%8C%E4%B8%8A).flac?sign=YwApO7y_8DE5OICrvzBfeiV2hl87h9gIsf6p3I0AMuw=:0",
    name : "骑在银龙的背上",
    artist:"中岛美雪",
    },
    {
      src:"https://cloud.lmxz.repl.co/d/%E8%87%AA%E7%94%A8/%E6%AD%8C%E6%9B%B2/%E7%8E%8B%E8%AF%97%E5%AE%89%20-%20Home.flac?sign=vcU2stQq1KYry9-ny_Zg3UU1BF-yTZdiVjPJZXmlcCg=:0",
      name : "Home",
      artist:"王诗安",
      },  
  {
  src:"http://music.163.com/song/media/outer/url?id=2414984",
  name : "Near or Far",
  artist:"Carissa Rae",
  },
  {
    src:"http://music.163.com/song/media/outer/url?id=412911436", 
    name : "画",
    artist:"邓紫棋", 
  },
  {
  src:"https://cloud.lmxz.repl.co/d/%E8%87%AA%E7%94%A8/%E6%AD%8C%E6%9B%B2/%E5%9D%82%E6%9C%AC%E9%BE%99%E4%B8%80%20-%20Aqua.flac?sign=wHgmqMctOeKZh4NrC0b-kjuDzLPe1wNpcXWdFH4i84g=:0",
  name : "Aqua",
  artist:"坂本龙一", 
  },
  {
    src:"http://music.163.com/song/media/outer/url?id=2001320",
    name : "Valder Fields",
    artist:"Tamas Wells", 
  },

  {
    src:"http://music.163.com/song/media/outer/url?id=28188427", 
    name : "棠梨煎雪",
    artist:"银临", 
  },
  {
    src:"http://ws.stream.qqmusic.qq.com/C400004TbR0e1Wbk7S.m4a?guid=795833580&vkey=3F11CA9ED149BE406102E2837401D700723E6D1BE095D81BA840454D2E38082B5F17047D37546802EC2564E32661CD0C34B102F3CFC84C92&uin=&fromtag=120032", 
    name : "时结",
    artist:"周深", 
  },
  {
    src:"http://music.163.com/song/media/outer/url?id=22707003", 
    name : "天空中闪烁着光",
    artist:"铃汐", 
  },
  {
    src:"music/大人",
    name : "大人",
    artist:"Sondia", 
  },

];

//events object
let events = {
  mouse: {
    click: "click",
  },
  touch: {
    click: "touchstart",
  },
};

// 主容器
const wrapper = document.querySelector('.wrapper'),
  // 封面
  musicImg = wrapper.querySelector('.img-area img'),
  //   歌曲名
  musicName = wrapper.querySelector('.song-details .name'),
  //   唱作者
  musicArtist = wrapper.querySelector('.song-details .artist'),
  //   播放器
  mainAudio = wrapper.querySelector('#main-audio'),
  //   播放/暂停按钮
  playPauseBtn = wrapper.querySelector('.play-pause'),
  //   上一曲
  prevBtn = wrapper.querySelector('#prev'),
  //   下一曲
  nextBtn = wrapper.querySelector('#next'),
  //   进度条
  progressBar = wrapper.querySelector('.progress-bar'),
  //   进度条容器
  progressArea = wrapper.querySelector('.progress-area'),
  //   当前时间
  musicCurrentTime = wrapper.querySelector('.current'),
  // 音乐总时长
  musicDuration = wrapper.querySelector('.duration'),
  //   播放模式按钮
  repeatBtn = wrapper.querySelector('#repeat-plist'),
  // 歌单容器
  musicList = wrapper.querySelector('.music-list'),
  // 歌单按钮
  showMoreBtn = wrapper.querySelector('#more-music'),
  // 关闭歌单按钮
  hideMusicBtn = musicList.querySelector('#close');

//   正在播放的音乐序号
let musicIndex = 1;
let slowm = 3;

window.addEventListener('load', () => {
  loadMusic(musicIndex);
  // 重新计算列表样式
  playingNow();
});

//  加载音乐
function loadMusic(indexNumb) {
  // 音乐名
  musicName.innerText = allMusic[indexNumb - 1].name;
  //   唱作人名
  musicArtist.innerText = allMusic[indexNumb - 1].artist;
  //   封面
  musicImg.src = `img/${allMusic[indexNumb - 1].name}.jpg`;
  //   音乐源
  mainAudio.src = `${allMusic[indexNumb - 1].src}.mp3`;
  playingNow();
}

// 播放音乐
function playMusic() {
  // 先给外层容器写上一个播放音乐的类标识
  wrapper.classList.add('paused');
  //   改变类进而改变图标
  playPauseBtn.querySelector('i').className = 'fas fa-pause';
  // 然后播放音乐
  mainAudio.play();
  // 重新计算列表样式
  playingNow();
}

// 暂停音乐
function pauseMusic() {
  // 移除播放标识
  wrapper.classList.remove('paused');
  //   改变类进而改变图标
  playPauseBtn.querySelector('i').className = 'fas fa-play';
  //   暂停播放
  mainAudio.pause();
  // 重新计算列表样式
  playingNow();
}

// 下一曲
function nextMusic() {
  //   改变当前值
  musicIndex++;
  if (repeatBtn.className.split(' ')[1] == 'fa-random')
  {
    musicIndex = Math.floor(Math.random()*(allMusic.length))//不知道是不是用+1
    if (musicIndex<=allMusic.length && musicIndex>=allMusic.length-slowm)
    {
      musicIndex = 24; 
    }
  }
  //   边界判定
  musicIndex > allMusic.length ? (musicIndex = 1) : (musicIndex = musicIndex);
  //   重新加载音乐
  loadMusic(musicIndex);
  //   播放
  playMusic();
  // 重新计算列表样式
  playingNow();
}

// 上一曲
function prevMusic() {
  //   改变当前值
  musicIndex--;
  if (repeatBtn.className.split(' ')[1] == 'fa-random')
  {
    musicIndex = Math.floor(Math.random()*(allMusic.length))//不知道是不是用+1
    if (musicIndex<=allMusic.length && musicIndex>=allMusic.length-slowm)
    {
      musicIndex = 24; 
    }
  }
  //   边界判定
  musicIndex < 1 ? (musicIndex = allMusic.length) : (musicIndex = musicIndex);
  //   重新加载音乐
  loadMusic(musicIndex);
  //   播放
  playMusic();
  // 重新计算列表样式
  playingNow();
}

// 为播放/暂停按钮绑定监听事件
playPauseBtn.addEventListener('click', () => {
  const isMusicPaused = wrapper.classList.contains('paused');
  isMusicPaused ? pauseMusic() : playMusic();
  // 重新计算列表样式
  playingNow();
});

// 为下一曲按钮绑定监听事件
nextBtn.addEventListener('click', () => {
  nextMusic();
});

// 为上一曲绑定监听事件
prevBtn.addEventListener('click', () => {
  prevMusic();
});

// 根据当前播放的进度改变进度条
mainAudio.addEventListener('timeupdate', e => {
  //   得到当前播放的时间
  const currentTime = e.target.currentTime;
  // 得到总时长
  const duration = e.target.duration;
  // 相除乘于100后就可以得到百分比数
  let progresswidt = (currentTime / duration) * 100;
  //   改变进度条的宽度即可
  progressBar.style.width = progresswidt + '%';
  // 当前帧的数据已加载，但没有足够的数据来播放指定音频/视频的下一帧时，会发生loadeddata事件）
  //   之所以在这里得到总时长是因为外面的timeupdate事件第一次调用时没有总时长这个参数的。只有当前时间
  mainAudio.addEventListener('loadeddata', () => {
    // 得到音乐总时长
    let audioDuration = mainAudio.duration;
    // 计算得到分钟
    let totalMin = Math.floor(audioDuration / 60);
    // 计算得到秒钟，不断对60取余数，不足60s的就是最终的秒钟
    let totalSec = Math.floor(audioDuration % 60);
    // 不足10s补0
    if (totalSec < 10) {
      totalSec = '0' + totalSec;
    }
    musicDuration.innerText = `${totalMin}:${totalSec}`;
  });

  let currMin = Math.floor(currentTime / 60);
  // 得到秒钟，不断对60取余数，不足60s的就是最终的秒钟
  let currSec = Math.floor(currentTime % 60);
  // 不足10s补0
  if (currSec < 10) {
    currSec = '0' + currSec;
  }
  //   改变播放条上的当前时间和总时间
  musicCurrentTime.innerText = `${currMin}:${currSec}`;
});

// 点击进度条容器触发的事件（因为进度条的长度是变化所以不能使用进度条）
progressArea.addEventListener('click', e => {
  // 得到进度条的宽度
  let progressWidthval = progressArea.clientWidth;
  // 得到点击位置的x坐标（相对于进度条）
  let clickedOffSetX = e.offsetX;
  //   得到播放总时长
  let songDuration = mainAudio.duration;

  //  改变当前的时间
  mainAudio.currentTime = (clickedOffSetX / progressWidthval) * songDuration;
  playMusic();
});

// 点击播放模式按钮
repeatBtn.addEventListener('click', () => {
  // 得到当前模式,因为类名是 fas fa-xxx模式的，取后面的值
  let curModel = repeatBtn.className.split(' ')[1];

  switch (curModel) {
    case 'fa-redo-alt':
      repeatBtn.className = 'fas fa-sync-alt';
      repeatBtn.setAttribute('title', '单曲循环');
      break;
    case 'fa-sync-alt':
      repeatBtn.className = 'fas fa-random';
      repeatBtn.setAttribute('title', '随机播放');
      break;
    case 'fa-random':
      repeatBtn.className = 'fas fa-redo-alt';
      repeatBtn.setAttribute('title', '顺序播放');
  }
});

// 当播放完一首歌时接下来要做的事情,根据播放模式决定
mainAudio.addEventListener('ended', () => {
  // 得到当前模式,因为类名是 fas fa-xxx模式的，取后面的值
  let curModel = repeatBtn.className.split(' ')[1];

  switch (curModel) {
    // 顺序播放就下一曲
    case 'fa-redo-alt':
      nextMusic();
      break;
    case 'fa-sync-alt':
      mainAudio.currentTime = 0;
      loadMusic(musicIndex);
      playMusic();
      break;
    case 'fa-random':
      //  创造一个随机数,0-1之间的随机数+1取整
      let randindex = Math.floor(Math.random() * allMusic.length - slowm);
      do {
        randindex = Math.floor(Math.random() * allMusic.length - slowm);
      } while (randindex == musicIndex);
      musicIndex = randindex;
      loadMusic(musicIndex);
      playMusic();
      // 重新计算列表样式
      playingNow();
      break;
  }
});

// 点击音乐列表按钮时打开列表
showMoreBtn.addEventListener('click', () => {
  musicList.classList.toggle('show');
});

// 点击关闭列表按钮
hideMusicBtn.addEventListener('click', () => {
  showMoreBtn.click();
});

// 循环生成列表内的数据
const ulTag = wrapper.querySelector('ul');
for (let index = 0; index < allMusic.length; index++) 
{
  let liTag = `
    <li li-index="${index + 1}">
        <div class="row">
        <span>${allMusic[index].name}</span>
        <p>${allMusic[index].artist}</p>
        </div>
        <audio class="${allMusic[index].name.slice(0,3)}" 
               src="${allMusic[index].src}.mp3">
        </audio>
        <span id="${allMusic[index].name.slice(0,3)}" class="audio-duration">3:28</span>
    </li>
  `;
  // 插入在结束标签之后
  ulTag.insertAdjacentHTML('beforeend', liTag);

  // li下面那个span实例，用来修改音乐时长
  let liAudioDuration = ulTag.querySelector(`#${allMusic[index].name.slice(0,3)}`);
  // li下面的播放器实例
  let liAudioTag = ulTag.querySelector(`.${allMusic[index].name.slice(0,3)}`);

  // 通过播放器实例得到音乐时长
  liAudioTag.addEventListener('loadeddata', () => {
    // 得到音乐总时长

    let audioDuration = liAudioTag.duration;
    // 计算得到分钟
    let totalMin = Math.floor(audioDuration / 60);
    // 计算得到秒钟，不断对60取余数，不足60s的就是最终的秒钟
    let totalSec = Math.floor(audioDuration % 60);
    // 不足10s补0

    if (totalSec < 10) {
      totalSec = '0' + totalSec;
    }
     liAudioDuration.innerText = `${totalMin}:${totalSec}`;
     // 将每首歌的时长保留到标签上，后续切歌用于回写音乐时长，从Playing回写
     liAudioDuration.setAttribute('t-duration', `${totalMin}:${totalSec}`);
  });  

}

// 得到所有的li标签
const allLiTags = ulTag.querySelectorAll('li');

// 计算正在播放的并处理样式
function playingNow() {
  console.log('执行这里');

  for (let index = 0; index < allLiTags.length; index++) {
    // 得到正在播放的标签
    let audioTag = allLiTags[index].querySelector('.audio-duration');
    // 进来的时候先移除上一个已经有的，防止出现重复
    if (allLiTags[index].classList.contains('playing')) {
      allLiTags[index].classList.remove('playing');
      // 回写时长
      audioTag.innerText = audioTag.getAttribute('t-duration');
    }
    // 给当前播放的音乐行添加一个类
    if (allLiTags[index].getAttribute('li-index') == musicIndex) {
      allLiTags[index].classList.add('playing');
      // 给正在播放的歌时间改成playing
      audioTag.innerText = 'Playing';
    }

    // 给所有的li行添加点击事件
    allLiTags[index].setAttribute('onclick', 'clicked(this)');
  }
}

function clicked(ele) {
  // 得到点击行
  let getLiIndex = ele.getAttribute('li-index');
  // 改变当前播放的音乐
  musicIndex = getLiIndex;
  // 重新加载音乐
  loadMusic(musicIndex);
  // 播放
  playMusic();
}
